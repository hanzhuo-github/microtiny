---
lang: zh-CN
title: 第二层到第三层
description:
article: false
---

## 1. 物理层 & MAC 层

### 1.1 第一层（物理层）

设备：集线器（Hub），广播

### 1.2 第二层（数据链路层）

#### MAC（Medium Access Control，媒体访问控制）

- 解决的是谁先发谁后发的问题，学名是**多路访问**。有很多算法解决这个问题：
    1. 信道划分：分多个道，你走你的，我走我的
    2. 轮流协议：轮着来
    3. 随机接入协议（以太网就用的这种方式）：管他三七二十一，先出门，堵的话就回去
- 判断发给谁，谁接收
    - 链路层地址，也被称为 MAC 地址
    - 第二层的网络包格式：
        |目标 MAC<br>（6 bytes）|源 MAC<br>（6 bytes）|类型<br>（2 bytes）|数据<br>（46-1500 bytes）|CRC<br>（4 bytes）|
        |:-:|:-:|:-:|:-:|:-:|

        - 类型：0800 - IP 数据报，0860 - ARP 请求
        - CRC 循环冗余检测：通过 XOR 异或来计算整个包是否在发送的过程中出现了了错误

#### ARP 协议

问题：如果一个广播网络里面接入了 N 台机器，怎么知道每台机器的 MAC 地址呢？

答案：ARP 协议 - 根据 IP 地址找 MAC 地址的协议。这是一个输出全靠“吼”的阶段。

|目标 MAC<br>（6 bytes）|源 MAC<br>（6 bytes）|类型<br>（2 bytes）|ARP 报文|
|:-:|:-:|:-:|:-:|

过程：要发送数据的机器发送一个广播包，等目的 IP 对应的机器来回应自己。

ARP 报文格式：
|硬件类型<br>（Ethernet）|协议类型<br>（IP）|硬件地址长度<br>（6）|协议地址长度<br>（6）|操作代码<br>（1 request 2 reply）|发送者 MAC|发送者 IP|目标 MAC|目标 IP|
|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|

ARP 缓存：为了避免每次都用 ARP 请求，机器本地也会进行 ARP 缓存。由于机器会不断上线下线，IP 也可能会变，所以 ARP 的 MAC 地址缓存过一段时间就会过期。

#### 转发表

机器数少的时候，我们可以用集线器组网。集线器是广播的，每个端口不管是否需要该包，都会接收然后发给主机，然后让主机自己判断是否需要。当机器数多的时候，端口什么都接受什么都转发的话，会更容易产生冲突，而且把不需要的包转发出去纯属浪费。

我们需要稍微智能一点的设备，该设备每个口可以解析 MAC 头，检查下目标 MAC 地址，然后根据策略进行转发。即第二层设备：交换机。

交换机如何知道每个口的电脑的 MAC 地址呢？需要交换机会学习，学习的结果叫做**转发表**。

电脑 A 向电脑 B 发送一个包，当包到达交换机时，最开始交换机并不知道电脑 B 在哪个口，于是它只能将包发送给除了连接电脑 A 口以外的其他口。交换机聪明之处在于，它会记住，电脑 A（对应的MAC）在哪个口。以后遇到目的地址是电脑 A 的 MAC 地址时，直接发送到对应的口就行。

这样过了一段时间之后，交换机就有了整个网络的结构了，这时基本不用广播了，可以准确转发。






        


### 1.3 交换机与 VLAN


下图是两台交换机连接三个局域网的情况。

<div align=center>
    <img src=/images/basic/network/section1/Lan.png width=50%/>
</div>

当机器 1 向机器 4（已知其 IP）发送包的时候，目的 MAC 还不知道，所以需要先用 ARP 获取目的 MAC。

:::details 简述交换机学习网络拓扑信息的过程
现在两台交换机都不了解网络的任何拓扑信息。

机器 1 发起广播。机器 2 能收到，但是没它啥事。交换机 A 也收到了这个广播，此时它不知道网络的拓扑信息，于是它将该广播包转发给除了广播包来的方向之外的其他所有网口。

机器 3 也收到了信息，但是这和它也没啥关系。交换机 B 同样收到了该广播包，它也不知道网络的拓扑信息，于是它也按照广播策略将包转发到 LAN 3。此时，机器 4 和机器 5 都能收到广播信息。机器 4 主动响应，这是找我的，我的 MAC 是 blabla。于是一个 ARP 请求就完成了。

在上面的过程中，两台交换机都学到了这样的信息：机器 1 是在左边的网口。

下次当机器 2 要访问机器 1 时，先通过 ARP 获取机器 1 的 MAC 地址。知道目的 MAC 后，发送数据包。该消息会到达机器 1，也会到交换机 A。交换机已经知道了机器 1 不在右边的网口，于是这个广播信息不会广播到 LAN 2 和 LAN 3。
:::

#### 环路问题 & STP 协议

环路问题会导致 ARP 请求爆炸，且交换机无法学习到网络的拓扑结构。

数据结构中有**最小生成树**，有环的我们常称为**图**。将图中的环破坏了，就生成了**树**。计算机网络中生成树算法是STP（Spanning Tree Protocol）。

<div align=center>
    <img src=/images/basic/network/section1/stp.png width=50%/>
</div>

STP 中的概念：
- Root Bridge，根交换机
- Designated Bridge，指定交换机
- Bridge Protocol Data Unit，BPDU，网桥协议数据单元。“互相比较实例”的协议。只有 Root Bridge 可以发，其他交换机只能转。
- Priority Vector，优先级向量。`[Root Bridge ID, Root Path Cost, Bridge ID, Port ID]`。在 BPDU 中。

#### 广播问题 & 安全问题

**物理隔离**：使用单独的交换机配置单独的子网

**虚拟隔离**，**虚拟局域网（VLAN）**：一个交换机上会连属于多个局域网的机器。

交换机如何区别某个机器属于哪个局域网呢？在原来的二层的头上加一个 TAG，里面有一个 VLAN ID，一共12位（可以划分 4096 个 VLAN）。这样仍然不够，目前云计算厂商例绝对不止 4096 个用户。当然每个用户需要一个 VLAN，后面章节再讲这个问题。

<div align=center>
    <img src=/images/basic/network/section1/vlan.png width=50%/>
</div>

如果我们使用的交换机是支持 VLAN 的，当交换机把二层的头取下来时就可以识别 VLAN ID。这样，只有相同 VLAN 的包才会互相转发，不同 VLAN 的包是看不到的。

对于支持 VLAN 的交换机，有一种口叫 Trunk 口。它可以转发属于任何 VLAN 的数据，交换机之间可以通过这种口互相连接。

<div align=center>
    <img src=/images/basic/network/section1/trunk.png width=50%/>
</div>


